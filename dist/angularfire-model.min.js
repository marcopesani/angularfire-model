!function(a){"use strict";a.module("marcopesani.ngFirebaseModel",["firebase","angularMoment"]).factory("$firebaseModel",["$log","$q","$firebaseModelValidator","$firebaseArray","$firebaseObject",function(b,c,d,e,f){function g(a,b,c){return this instanceof g?(this.$$baseRef=c,this.$$modelRef=c.child(b),this.$$modelName=a,this.$$modelCollection=b,this.$$schema={},this.$$validator=d({debug:!0}),this):new g(a,b,c)}return g.prototype={$all:function(){return e(this.$$modelRef)},$one:function(a){var b=this.$$modelRef.child(a);return f(b)},$add:function(b){var d,e=this,f=c.defer(),g=this.$$validator.$validate(b);return g.success===!0?(d=this.$$modelRef.push(b),d.once("value",function(b){var c=b.exists()?b.val():null;c&&(a.forEach(c,function(a,c){e.$$schema[c]&&"relationship"===e.$$schema[c].type&&e.$$createRelationship(b.key(),a,e.$$schema[c])}),f.resolve(g))})):f.reject(g),f.promise},$isValid:function(a){var b=this.$$validator.$validate(a);return b.success},$remove:function(b){var c=this,d=this.$$modelRef.child(b);d.once("value",function(b){var e=b.exists()?b.val():null;e&&a.forEach(e,function(a,d){c.$$schema[d]&&"relationship"===c.$$schema[d].type&&c.$$removeRelationship(b.key(),a,c.$$schema[d])}),d.remove()})},$addRelationship:function(a,b){var c={type:"relationship",localType:b.localType,foreingType:b.foreingType,foreingCollection:b.foreingCollection};if(b.foreingKey)c.foreingKey=b.foreingKey;else switch(c.foreingType){case"value":c.foreingKey=this.$$modelName;break;case"collection":c.foreingKey=this.$$modelCollection}return this.$$schema[a]=c,this},$addAttribute:function(a){var b={type:"attribute"};return this.$$schema[a]=b,this},$addValidationRule:function(a,b,c){return this.$$validator.$addValidationRule(a,b,c),this},$$createRelationship:function(c,d,e){var f=this,g=function(a,b,c){"value"===c.foreingType?f.$$baseRef.child(c.foreingCollection).child(b).child(c.foreingKey).set(a):"collection"===c.foreingType&&f.$$baseRef.child(c.foreingCollection).child(b).child(c.foreingKey).child(a).set(!0)};switch(e.localType){case"value":g(c,d,e);break;case"collection":a.forEach(d,function(a,b){g(c,b,e)});break;default:b.error("$firebaseModel.$$createRelationship can handle only string or objects.")}},$$removeRelationship:function(c,d,e){var f=this,g=function(a,b,c){"value"===c.foreingType?f.$$baseRef.child(c.foreingCollection).child(b).child(c.foreingKey).remove():"collection"===c.foreingType&&f.$$baseRef.child(c.foreingCollection).child(b).child(c.foreingKey).child(a).remove()};switch(e.localType){case"value":g(c,d,e);break;case"collection":a.forEach(d,function(a,b){g(c,b,e)});break;default:b.error("$firebaseModel.$$removeRelationship can handle only string or objects.")}}},g}])}(window.angular),function(a){"use strict";a.module("marcopesani.ngFirebaseModel").factory("$firebaseModelValidator",["$log","moment",function(b,c){var d=function(a){return this instanceof d?(this.$$rules={},this.$$debug=a&&a.debug?a.debug:!1,this):new d(a)};return d.prototype={$addValidationRule:function(a,c,d){if(a&&c){var e={type:c,options:d||void 0};this.$$rules[a]=this.$$rules[a]||[],this.$$rules[a].push(e)}else b.error("$firebaseModel.$addValidationRule requires the key to check and the rule to apply.")},$validate:function(b){function d(a,b){f.success=!1,f[a]=f[a]||[],f[a].push(b)}var e=this,f={success:!0};return a.forEach(this.$$rules,function(f,g){var h=e.$$rules[g];a.forEach(h,function(a){switch(a.type){case"NotBlank":b[g]&&""!==b[g]||d(g,"This value should not be blank");break;case"Blank":(b[g]||0!==b[g].length)&&d(g,"This value should be blank");break;case"NotNull":b[g]||b[g]===!1||d(g,"This value should exists");break;case"Null":b[g]&&d(g,"This value should not exists");break;case"True":b[g]!==!0&&d(g,"This value should be true");break;case"False":b[g]!==!1&&d(g,"This value should be false");break;case"Date":c(b[g],"YYYY-MM-DD").isValid()||d(g,"This is not a valid ISO8601 Date string, the format should be YY-MM-DD");break;case"Time":c(b[g],"HH:mm:ssZ").isValid()||d(g,"This is not a valid ISO8601 Time string, the format should be HH:mm:ssZ");break;case"DateTime":c(b[g],"YYYY-MM-DDTHH:mm:ssZ").isValid()||d(g,"This is not a valid ISO8601 DateTime string, the format should be YYYY-MM-DDTHH:mm:ssZ")}})}),f}},d}])}(window.angular);